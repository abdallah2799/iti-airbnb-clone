@if (listing(); as currentListing) {
<div class="listing-detail-container pb-20">
  <div class="max-w-[1120px] mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header Section -->
    <div class="pt-6 pb-4">
      <h1 class="text-2xl md:text-3xl font-bold text-[#222222] mb-2">{{ currentListing.title }}</h1>

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <!-- Reviews & Location -->
        <div class="flex flex-wrap items-center gap-2 text-sm text-[#222222]">
          @if (currentListing.reviews && currentListing.reviews.length > 0) {
          <div class="flex items-center gap-1 font-medium">
            <lucide-icon [img]="icons.Star" class="w-3 h-3 fill-current"></lucide-icon>
            <span>{{ getAverageRating() | number:'1.1-1' }}</span>
            <span>·</span>
            <a href="#reviews" class="underline hover:text-gray-600 transition">
              {{ currentListing.reviews.length }} review{{ currentListing.reviews.length !== 1 ? 's' : '' }}
            </a>
          </div>
          <span class="hidden md:inline">·</span>
          }

          @if (isSuperhost()) {
          <div class="flex items-center gap-1 font-medium">
            <lucide-icon [img]="icons.Medal" class="w-3 h-3"></lucide-icon>
            <span>Superhost</span>
          </div>
          <span class="hidden md:inline">·</span>
          }

          <div class="font-medium underline hover:text-gray-600 cursor-pointer transition">
            {{ currentListing.city }}, {{ currentListing.country }}
          </div>
        </div>

        <!-- Share & Save Buttons -->
        <div class="flex items-center gap-2 text-sm font-medium text-[#222222]">
          <button class="flex items-center gap-2 hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
            <lucide-icon [img]="icons.Share" class="w-4 h-4"></lucide-icon>
            <span class="underline">Share</span>
          </button>
          <button (click)="toggleFavorite($event)"
            class="flex items-center gap-2 hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
            <lucide-icon [img]="icons.Heart" class="w-4 h-4" [class.fill-[#FF385C]]="isFavorite()"
              [class.text-[#FF385C]]="isFavorite()" [class.fill-transparent]="!isFavorite()"
              [class.text-black]="!isFavorite()">
            </lucide-icon>
            <span class="underline">{{ isFavorite() ? 'Saved' : 'Save' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Photo Gallery (Adaptive) -->
    @if (hasPhotos()) {
    <div class="photo-gallery mb-8 relative rounded-xl overflow-hidden h-[400px] lg:h-[480px] bg-gray-100">

      <!-- LAYOUT 1: SINGLE HERO (1 Photo) -->
      @if (totalPhotos() === 1) {
      <div class="w-full h-full relative cursor-pointer group" (click)="openPhotoModal(0)">
        <img [src]="currentListing.photos[0].url" [alt]="currentListing.title"
          class="w-full h-full object-cover group-hover:brightness-95 transition-all">
      </div>
      }

      <!-- LAYOUT 2: SPLIT VIEW (2-4 Photos) -->
      @if (totalPhotos() >= 2 && totalPhotos() < 5) { <div class="grid grid-cols-2 gap-2 h-full">
        <!-- Main Photo (Left) -->
        <div class="relative cursor-pointer group h-full" (click)="openPhotoModal(0)">
          <img [src]="currentListing.photos[0].url" [alt]="currentListing.title"
            class="w-full h-full object-cover group-hover:brightness-95 transition-all">
        </div>
        <!-- Secondary Photos (Right Stack) -->
        <div class="grid gap-2 h-full" [class.grid-rows-1]="totalPhotos()===2" [class.grid-rows-2]="totalPhotos()>2">
          @for (photo of currentListing.photos.slice(1, 5); track photo.id; let i = $index) {
          <div class="relative cursor-pointer group h-full" (click)="openPhotoModal(i + 1)">
            <img [src]="photo.url" class="w-full h-full object-cover group-hover:brightness-95 transition-all">
          </div>
          }
        </div>
    </div>
    }

    <!-- LAYOUT 3: FULL GRID (5+ Photos - The Airbnb Standard) -->
    @if (totalPhotos() >= 5) {
    <div class="hidden md:grid grid-cols-4 grid-rows-2 gap-2 h-full">
      <!-- Main Photo (Left Half) -->
      <div class="col-span-2 row-span-2 relative cursor-pointer group" (click)="openPhotoModal(0)">
        <img [src]="currentListing.photos[0].url" [alt]="currentListing.title"
          class="w-full h-full object-cover group-hover:brightness-95 transition-all">
      </div>

      <!-- Secondary photos -->
      @for (photo of currentListing.photos.slice(1, 5); track photo.id; let i = $index) {
      <div class="relative cursor-pointer group" (click)="openPhotoModal(i + 1)">
        <img [src]="photo.url" [alt]="'Photo ' + (i + 2)"
          class="w-full h-full object-cover group-hover:brightness-95 transition-all">

        <!-- Overlay on 4th small photo if > 5 -->
        @if (i === 3 && totalPhotos() > 5) {
        <div
          class="absolute inset-0 bg-black/40 flex items-center justify-center text-white font-semibold text-lg backdrop-blur-[1px] group-hover:bg-black/50 transition-all">
          Show all {{ totalPhotos() }} photos
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Mobile Gallery (Carousel) - Only needed if layout 3 is hidden on mobile -->
    @if (totalPhotos() >= 5) {
    <div class="md:hidden relative w-full h-full bg-gray-200">
      @if (currentPhoto()) {
      <img [src]="currentPhoto()!.url" [alt]="currentListing.title" class="w-full h-full object-cover">
      }

      <!-- Mobile Nav -->
      @if (totalPhotos() > 1) {
      <button (click)="previousPhoto()"
        class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 p-2 rounded-full shadow-md">
        <lucide-icon [img]="icons.ChevronLeft" class="w-5 h-5"></lucide-icon>
      </button>
      <button (click)="nextPhoto()"
        class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 p-2 rounded-full shadow-md">
        <lucide-icon [img]="icons.ChevronRight" class="w-5 h-5"></lucide-icon>
      </button>
      }
      <div class="absolute bottom-4 right-4 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium">
        {{ currentPhotoIndex() + 1 }} / {{ totalPhotos() }}
      </div>
    </div>
    }

    <!-- Show All Button (Desktop) -->
    <button (click)="openPhotoModal(0)"
      class="hidden md:flex absolute bottom-6 right-6 bg-white border border-black px-4 py-1.5 text-sm font-semibold rounded-md shadow-sm hover:bg-gray-100 items-center gap-2 z-20">
      <lucide-icon [img]="icons.Grid" class="w-4 h-4"></lucide-icon>
      Show all photos
    </button>
  </div>
  }

  <!-- Main Content Grid (2/3 Left, 1/3 Right) -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 relative">

    <!-- LEFT COLUMN -->
    <div class="lg:col-span-2">

      <!-- Host Info -->
      <div class="flex justify-between items-center py-8 border-b border-gray-200">
        <div>
          <h2 class="text-xl font-semibold text-[#222222] mb-1">Entire place hosted by {{
            currentListing.host.fullName
            }}</h2>
          <p class="text-gray-600 text-sm">
            {{ currentListing.maxGuests }} guests · {{ currentListing.numberOfBedrooms }} bedrooms · {{
            currentListing.numberOfBathrooms }} baths
          </p>
        </div>
        <div class="w-14 h-14 rounded-full overflow-hidden border border-gray-200">
          <img [src]="currentListing.host.profilePictureUrl || 'https://a0.muscache.com/defaults/user_pic-225x225.png'"
            class="w-full h-full object-cover" alt="Host">
        </div>
      </div>

      <!-- Key Features (Highlights) -->
      <div class="py-8 border-b border-gray-200 space-y-6">
        <div class="flex gap-4">
          <lucide-icon [img]="icons.Home" class="w-6 h-6 text-[#222222]"></lucide-icon>
          <div>
            <h3 class="font-semibold text-[#222222]">Entire home</h3>
            <p class="text-gray-500 text-sm">You’ll have the apartment to yourself.</p>
          </div>
        </div>
        <div class="flex gap-4">
          <lucide-icon [img]="icons.Sparkles" class="w-6 h-6 text-[#222222]"></lucide-icon>
          <div>
            <h3 class="font-semibold text-[#222222]">Enhanced Clean</h3>
            <p class="text-gray-500 text-sm">This host committed to Airbnb's 5-step enhanced cleaning process.</p>
          </div>
        </div>
        <div class="flex gap-4">
          <lucide-icon [img]="icons.MapPin" class="w-6 h-6 text-[#222222]"></lucide-icon>
          <div>
            <h3 class="font-semibold text-[#222222]">Great location</h3>
            <p class="text-gray-500 text-sm">100% of recent guests gave the location a 5-star rating.</p>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="py-8 border-b border-gray-200">
        <p class="text-gray-700 whitespace-pre-line leading-relaxed text-base"
          [class.line-clamp-6]="!isDescriptionExpanded()">
          {{ currentListing.description }}
        </p>
        @if (currentListing.description.length > 250) {
        <button (click)="toggleDescription()"
          class="flex items-center gap-1 font-semibold underline mt-4 hover:text-gray-600">
          {{ isDescriptionExpanded() ? 'Show less' : 'Show more' }}
          <lucide-icon [img]="icons.ChevronRight" class="w-4 h-4 transition-transform"
            [class.rotate-90]="isDescriptionExpanded()"></lucide-icon>
        </button>
        }
      </div>

      <!-- Amenities -->
      <div class="py-8 border-b border-gray-200">
        <h3 class="text-xl font-semibold mb-6">What this place offers</h3>
        @if (listingAmenities() && listingAmenities().length > 0) {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          @for (amenity of listingAmenities() | slice:0:10; track amenity.name) {
          <div class="flex items-center gap-3">
            <!-- Use a generic icon if dynamic icon is missing or complex -->
            <lucide-icon [img]="icons.Check" class="w-5 h-5 text-gray-600"></lucide-icon>
            <span class="text-gray-700">{{ amenity.name }}</span>
          </div>
          }
        </div>
        <button class="mt-8 border border-black rounded-lg px-6 py-3 font-semibold hover:bg-gray-50 transition-colors">
          Show all {{ listingAmenities().length }} amenities
        </button>
        } @else {
        <p class="text-gray-500 italic">No specific amenities listed.</p>
        }
      </div>

      <!-- Map Location -->
      <div class="py-8">
        <h3 class="text-xl font-semibold mb-6">Where you'll be</h3>
        <div class="h-[480px] w-full bg-gray-100 rounded-xl overflow-hidden relative">
          <!-- Assuming you have a Map Component, otherwise show placeholder -->
          <app-map *ngIf="currentListing.latitude && currentListing.longitude" [lat]="currentListing.latitude"
            [lng]="currentListing.longitude" [zoom]="13">
          </app-map>
          <div *ngIf="!currentListing.latitude" class="w-full h-full flex items-center justify-center text-gray-400">
            Map data unavailable
          </div>
        </div>
        <div class="mt-4 font-semibold text-[#222222]">{{ currentListing.city }}, {{ currentListing.country }}</div>
        <p class="text-gray-600 text-sm mt-1">Detailed location provided after booking.</p>
      </div>

      <!-- Reviews Section -->
      <app-review-list [reviews]="currentListing.reviews || []"></app-review-list>

    </div> <!-- End Left Column -->

    <!-- RIGHT COLUMN: STICKY BOOKING CARD -->
    <div class="hidden lg:block relative">
      <div class="sticky top-32 border border-gray-200 rounded-xl shadow-[0_6px_16px_rgba(0,0,0,0.12)] p-6 bg-white">

        <div class="flex justify-between items-end mb-6">
          <div>
            <span class="text-2xl font-bold text-[#222222]">{{ currentListing.currency || '$' }}{{
              currentListing.pricePerNight }}</span>
            <span class="text-gray-600 text-base"> night</span>
          </div>
          <div class="flex items-center gap-1 text-sm mb-1">
            <lucide-icon [img]="icons.Star" class="w-3 h-3 fill-black text-black"></lucide-icon>
            <span class="font-semibold">{{ getAverageRating() | number:'1.1-1' }}</span>
            <span class="text-gray-400">·</span>
            <a href="#reviews" class="text-gray-500 underline hover:text-gray-800">
              {{ currentListing.reviews.length }} reviews
            </a>
          </div>
        </div>

        <!-- Date Inputs -->
        <div class="border border-gray-400 rounded-lg mb-4">
          <div class="grid grid-cols-2 border-b border-gray-400">
            <div class="p-3 border-r border-gray-400 hover:bg-gray-100 cursor-pointer">
              <label class="text-[10px] font-bold uppercase text-gray-800 block">CHECK-IN</label>
              <input type="date" [(ngModel)]="checkInDate"
                class="w-full text-sm outline-none bg-transparent cursor-pointer">
            </div>
            <div class="p-3 hover:bg-gray-100 cursor-pointer">
              <label class="text-[10px] font-bold uppercase text-gray-800 block">CHECKOUT</label>
              <input type="date" [(ngModel)]="checkOutDate"
                class="w-full text-sm outline-none bg-transparent cursor-pointer">
            </div>
          </div>
          <div class="p-3 hover:bg-gray-100 cursor-pointer">
            <label class="text-[10px] font-bold uppercase text-gray-800 block">GUESTS</label>
            <input type="number" [(ngModel)]="guests" min="1" [max]="currentListing.maxGuests"
              class="w-full text-sm outline-none bg-transparent cursor-pointer" placeholder="1 guest">
          </div>
        </div>

        <!-- Action Button -->
        <button (click)="checkAvailability()" [disabled]="isBookingLoading()"
          class="w-full bg-[#FF385C] hover:bg-[#E01D4D] text-white py-3.5 rounded-lg font-semibold text-lg transition-all mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
          {{ isBookingLoading() ? 'Checking...' : 'Reserve' }}
        </button>

        <!-- Contact Host Button -->
        <button (click)="contactHost()" [disabled]="isContactingHost()"
          class="w-full border-2 border-gray-900 hover:bg-gray-50 text-gray-900 py-3 rounded-lg font-semibold transition-all mb-4 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
          <lucide-icon [img]="icons.MessageSquare" class="w-5 h-5"></lucide-icon>
          <span>{{ isContactingHost() ? 'Opening chat...' : 'Contact Host' }}</span>
        </button>

        <p class="text-center text-sm text-gray-500 mb-6">You won't be charged yet</p>

        <!-- Price Calc -->
        <div class="space-y-4 text-gray-600 text-base">
          <div class="flex justify-between">
            <span class="underline cursor-pointer">{{ currentListing.currency || '$' }}{{
              currentListing.pricePerNight
              }} x {{ nights }} {{ nights === 1 ? 'night' : 'nights' }}</span>
            <span>{{ currentListing.currency || '$' }}{{ nightsPrice }}</span>
          </div>
          <div class="flex justify-between">
            <span class="underline cursor-pointer">Cleaning fee</span>
            <span>{{ currentListing.currency || '$' }}{{ cleaningFee }}</span>
          </div>
          <div class="flex justify-between">
            <span class="underline cursor-pointer">Airbnb service fee</span>
            <span>{{ currentListing.currency || '$' }}{{ serviceFee }}</span>
          </div>
          <hr class="border-gray-200 my-4">
          <div class="flex justify-between font-bold text-gray-900 text-lg">
            <span>Total before taxes</span>
            <span>{{ currentListing.currency || '$' }}{{ totalPrice }}</span>
          </div>
        </div>

      </div>

      <!-- Report Flag -->
      <div class="text-center mt-6">
        <button class="text-sm text-gray-500 hover:underline flex items-center justify-center gap-2 w-full">
          <lucide-icon [img]="icons.Flag" class="w-3 h-3"></lucide-icon>
          Report this listing
        </button>
      </div>

    </div> <!-- End Right Column -->

  </div>
</div>
</div>

<!-- Photo Modal -->
<div *ngIf="isPhotoModalOpen()" class="fixed inset-0 bg-black z-50 flex items-center justify-center"
  (click)="closePhotoModal()">
  <div class="relative w-full h-full flex items-center justify-center" (click)="$event.stopPropagation()">
    <button (click)="closePhotoModal()"
      class="absolute top-4 right-4 text-white bg-black/50 hover:bg-black/70 p-2 rounded-full z-10 transition-colors">
      <lucide-icon [img]="icons.X" class="w-6 h-6"></lucide-icon>
    </button>

    <button *ngIf="totalPhotos() > 1" (click)="previousPhoto()"
      class="absolute left-4 top-1/2 -translate-y-1/2 text-white bg-black/50 hover:bg-black/70 p-3 rounded-full z-10 transition-colors">
      <lucide-icon [img]="icons.ChevronLeft" class="w-6 h-6"></lucide-icon>
    </button>

    <button *ngIf="totalPhotos() > 1" (click)="nextPhoto()"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-white bg-black/50 hover:bg-black/70 p-3 rounded-full z-10 transition-colors">
      <lucide-icon [img]="icons.ChevronRight" class="w-6 h-6"></lucide-icon>
    </button>

    <div class="max-w-6xl max-h-[90vh] flex items-center justify-center p-4">
      <img [src]="currentPhoto()!.url" [alt]="'Photo ' + (currentPhotoIndex() + 1)"
        class="max-w-full max-h-full object-contain rounded-lg">
    </div>

    <!-- Photo Counter -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white bg-black/50 px-3 py-1 rounded-full text-sm">
      {{ currentPhotoIndex() + 1 }} / {{ totalPhotos() }}
    </div>
  </div>
</div>

} @else {
<!-- Loading State -->
<div class="flex items-center justify-center min-h-screen">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF385C] mx-auto"></div>
    <p class="mt-4 text-gray-600 text-sm">Loading listing details...</p>
  </div>
</div>
}